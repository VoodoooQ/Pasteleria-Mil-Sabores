<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Seguimiento de Pedido - Pastelería Mil Sabores</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <nav>
  <a href="inicio.html">Inicio</a>
  <a href="catalogo.html">Productos</a>
  <a href="perfil.html">Mi Perfil</a>
  <a href="seguimiento.html">Seguimiento</a>
  <a href="carrito.html">Carrito</a>
  <a href="detalle_carrito.html">Detalle Compra</a>
  <a href="blogs.html">Blogs</a>
  </nav>
  <h2>Seguimiento de Pedido</h2>
  <div id="pedidos-lista"></div>
  <div id="tracking-visual" style="display:flex;justify-content:center;align-items:center;gap:2em;margin-bottom:2em;"></div>
  <script src="funciones.js"></script>
  <script>
    function mostrarPedidos() {
      const usuario = JSON.parse(localStorage.getItem('usuario'));
      const pedidos = usuario && usuario.pedidos ? usuario.pedidos : [];
      const lista = document.getElementById('pedidos-lista');
      lista.innerHTML = '';
      if (!pedidos.length) {
        lista.innerHTML = '<p>No tienes pedidos realizados.</p>';
        return;
      }
      pedidos.forEach((pedido, i) => {
        // Formatear fecha de entrega y fecha de pedido a dd/mm/yyyy si no lo están
        let fechaEntrega = pedido.fechaEntrega || '-';
        if (fechaEntrega && fechaEntrega.includes('-')) {
          const f = new Date(fechaEntrega);
          const dia = String(f.getDate()).padStart(2, '0');
          const mes = String(f.getMonth() + 1).padStart(2, '0');
          const anio = String(f.getFullYear());
          fechaEntrega = `${dia}/${mes}/${anio}`;
        }
        let fechaPedido = pedido.fecha;
        if (fechaPedido && fechaPedido.includes('-')) {
          const f = new Date(fechaPedido);
          const dia = String(f.getDate()).padStart(2, '0');
          const mes = String(f.getMonth() + 1).padStart(2, '0');
          const anio = String(f.getFullYear());
          fechaPedido = `${dia}/${mes}/${anio}`;
        }
        lista.innerHTML += `
          <div class="producto" style="border:2px solid #FFC0CB;background:#FFF5E1;margin-bottom:2em;">
            <h3 style="font-family:Pacifico;color:#8B4513;">Pedido #${i+1}</h3>
            <p style="font-family:Lato;color:#5D4037;">Fecha: ${fechaPedido}</p>
            <p style="font-family:Lato;color:#8B4513;">Estado: <span style="color:${pedido.estado==='entregado'?'#8B4513':pedido.estado==='enviado'?'#FFC0CB':'#B0BEC5'};font-weight:bold;">${pedido.estado.charAt(0).toUpperCase()+pedido.estado.slice(1)}</span></p>
            <p style="font-family:Lato;color:#5D4037;">Fecha de entrega: ${fechaEntrega}</p>
            <ul>
              ${pedido.productos.map(p => `<li style='font-family:Lato;color:#5D4037;'>${p.nombre} x${p.cantidad} ${p.mensaje?`(${p.mensaje})`:''}</li>`).join('')}
            </ul>
            <button class="btn" onclick="cambiarEstado(${i})" style="background:#FFC0CB;color:#8B4513;">Avanzar Estado</button>
          </div>
        `;
        // Visual tracking para el pedido actual
        if (i === pedidos.length-1) {
          mostrarTrackingVisual(pedido.estado);
        }
      });
    }
    function cambiarEstado(index) {
      const usuario = JSON.parse(localStorage.getItem('usuario'));
      const pedidos = usuario.pedidos;
      const estados = ['preparación','enviado','entregado'];
      let actual = estados.indexOf(pedidos[index].estado);
      if (actual < estados.length-1) {
        pedidos[index].estado = estados[actual+1];
        localStorage.setItem('usuario', JSON.stringify(usuario));
        mostrarPedidos();
        // Animación visual
        setTimeout(()=>{
          mostrarTrackingVisual(pedidos[index].estado);
        },300);
      }
    // Visual tracking para el pedido actual
    function mostrarTrackingVisual(estadoActual) {
      const visual = document.getElementById('tracking-visual');
      visual.innerHTML = '';
      const estadosVisual = [
        {nombre:'preparación', color:'#B0BEC5', letra:'P'},
        {nombre:'enviado', color:'#FFC0CB', letra:'E'},
        {nombre:'entregado', color:'#8B4513', letra:'T'}
      ];
      estadosVisual.forEach((e, idx) => {
        const circle = document.createElement('div');
        circle.style.width = '48px';
        circle.style.height = '48px';
        circle.style.borderRadius = '50%';
        circle.style.background = e.color;
        circle.style.display = 'flex';
        circle.style.justifyContent = 'center';
        circle.style.alignItems = 'center';
        circle.style.fontFamily = 'Pacifico';
        circle.style.fontSize = '1.1em';
        circle.style.color = idx === estadosVisual.length-1 ? '#FFF5E1' : '#8B4513';
        circle.style.border = estadoActual === e.nombre ? '3px solid #8B4513' : '2px solid #B0BEC5';
        circle.style.boxShadow = estadoActual === e.nombre ? '0 0 12px #FFC0CB' : 'none';
        circle.textContent = e.letra;
        // Animación si es el estado actual
        if (estadoActual === e.nombre) {
          circle.animate([
            {transform:'scale(1)'},
            {transform:'scale(1.15)'},
            {transform:'scale(1)'}
          ], {duration:600,iterations:1});
        }
        visual.appendChild(circle);
        if (idx < estadosVisual.length-1) {
          const bar = document.createElement('div');
          bar.style.width = '48px';
          bar.style.height = '8px';
          bar.style.background = '#5D4037';
          bar.style.borderRadius = '4px';
          visual.appendChild(bar);
        }
      });
    }
    }
    mostrarPedidos();
  </script>
</body>
</html>
